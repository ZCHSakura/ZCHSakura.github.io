---
title: 机器学习打印训练日志
tags: 
- python
- 线程
- 机器学习
categories:
- 技术
- Python
top:
---

这里记录下我使用python的sklearn库中的机器学习模型，训练过程中使用打印训练日志的方法。

<!--more-->

> scikit-learn是Python十分出名的一个算法库，里面包含了非常多的机器学习算法，我们有一个场景需要选用多个机器学习算法同时要在训练过程中进行训练信息的打印，库中的有些算法本身是自带训练日志打印的，但是有些没有，因此我们主要需要解决以下两个问题：
>
> 1. 带训练过程的算法将训练过程打印到指定文件中
> 2. 不带训练过程的算法人为在训练过程中打印一些简单的训练内容

### 带过程算法训练日志打印

#### 启用训练日志

虽然有一些算法是自带训练过程输出的，但是基本默认都是不输出或者只输出很少一部分信息的，这里我们需要查看sklearn库中这个算法的实现注释，看有没有控制训练过程输出的参数，下面举一些例子。

```python
# 很多算法的训练过程打印都是通过verbose这个参数控制的，例如
clf = ensemble.HistGradientBoostingClassifier(verbose=1, **hyperparameter)
clf = ExtraTreesClassifier(verbose=3, **hyperparameter)
clf = RandomForestClassifier(verbose=99, **hyperparameter)

# 但也有一些是通过别的参数控制的，还是要自己去看算法实现里面的注释
clf = LocalOutlierFactor(novelty=True, **hyperparameter)

# 甚至Lightgbm还是在fit()函数中控制的
clf.fit(x, y, eval_set=[(x, y)], callbacks=[lgb.log_evaluation(1)])
```

#### 将训练日志输出到指定文件

这些算法基本都没有参数来接受训练日志输出位置（我遇见的只有一个例外，下面会讲），基本都是将训练日志直接默认输出到命令行，所以我们需要将原本输出到命令行中的内容重定向输出到指定文件中。

这里主要用到**sys.stdout**，下面先简单介绍下**sys.stdout**的基本用法

```python
import sys
print('111')

oldPrint = sys.stdout   # 用于后期还原

# 把输出重定向到文件
sys.stdout=open('outfile.log',"a+") 
print('222')

sys.stdout.close() # 关闭文件
sys.stdout = oldPrint  # 还原输出位置到命令行
```

这里其实看起来已经重定向的功能已经实现了，我们只需要将print('222')换为我们执行模型训练的内容即可，如下

```python
def train_model(algorithm, clf, x, y, train_log_path):
    cmd = sys.stdout
    sys.stdout = open(train_log_path, mode='a', encoding='utf-8')
    start = time.time()

    clf.fit(x, y)

    end = time.time()
    sys.stdout.close()
    sys.stdout = cmd

    return start, end
```

但是我们在实际使用的过程中还是发现了一些问题，就是有些算法使用的时候是没问题的，但是有些算法就不会实时写入，而是整个训练结束了才把内容写入指定文件，我们思考应该是flush的问题，于是重写了下**sys.stdout**的**wirte()**和**flush()**方法

```python
class Logger(object):
    def __init__(self, filename='default.log', stream=sys.stdout):
        self.terminal = stream
        self.log = open(filename, 'a', encoding='utf-8')

    def write(self, message):
        # self.terminal.write(message)
        # self.terminal.flush()
        self.log.write(message)
        self.log.flush()

    def flush(self):
        pass
    

def train_model(algorithm, clf, x, y, train_log_path):
    cmd = sys.stdout
    sys.stdout = Logger(train_log_path, sys.stdout)
    # sys.stdout = open(train_log_path, mode='a', encoding='utf-8')
    start = time.time()

    clf.fit(x, y)

    end = time.time()
    # sys.stdout.close()
    sys.stdout = cmd

    return start, end
```

这样进行修改之后发现所有算法的训练日志都能实时写入到指定文件中。
